{% extends "ledger/base.html" %}
{% load humanize %}

{% block title %}Split Entry #{{ entry.pk }} - Construction Ledger{% endblock %}

{% block content %}
<div class="d-flex align-items-center gap-3 mb-3">
    <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i></a>
    <nav aria-label="breadcrumb" class="mb-0">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'ledger:entry_list' %}">Entries</a></li>
            <li class="breadcrumb-item"><a href="{% url 'ledger:entry_detail' entry.pk %}">Entry #{{ entry.pk }}</a></li>
            <li class="breadcrumb-item active">Split</li>
        </ol>
    </nav>
</div>

<!-- Original entry summary -->
<div class="card p-4 mb-4">
    <h5 class="mb-3" style="color:var(--accent);">Original Entry #{{ entry.pk }}</h5>
    <div class="row">
        <div class="col-md-3"><small class="text-muted">Date</small><br><strong>{{ entry.date|date:"F d, Y"|default:"—" }}</strong></div>
        <div class="col-md-3"><small class="text-muted">Supplier</small><br><strong>{{ entry.supplier|default:"—" }}</strong></div>
        <div class="col-md-3"><small class="text-muted">Cost</small><br><strong>{% if entry.cost != None %}${{ entry.cost|floatformat:2|intcomma }}{% else %}—{% endif %}</strong></div>
        <div class="col-md-3"><small class="text-muted">Description</small><br><strong>{{ entry.description|default:"—"|truncatewords:10 }}</strong></div>
    </div>
</div>

<!-- Split count selector -->
<div class="d-flex align-items-center gap-3 mb-4">
    <h4 class="mb-0">Split into</h4>
    <div class="d-flex align-items-center gap-2">
        <a href="{% url 'ledger:entry_split' entry.pk %}?n={{ num_splits|add:"-1" }}"
           class="btn btn-sm btn-outline-secondary {% if num_splits <= 2 %}disabled{% endif %}">
            <i class="bi bi-dash"></i>
        </a>
        <span class="fs-4 fw-bold px-2" style="color:var(--accent);">{{ num_splits }}</span>
        <a href="{% url 'ledger:entry_split' entry.pk %}?n={{ num_splits|add:"1" }}"
           class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-plus"></i>
        </a>
    </div>
    <h4 class="mb-0">entries</h4>
</div>

<form method="post">
    {% csrf_token %}
    {{ formset.management_form }}
    <input type="hidden" name="num_splits" value="{{ num_splits }}">

    {% for form in formset %}
    <div class="card p-4 mb-3">
        <h6 style="color:var(--accent);" class="mb-3">Split Entry {{ forloop.counter }} of {{ num_splits }}</h6>
        <div class="row g-3">
            <div class="col-md-3">{{ form.date.label_tag }} {{ form.date }}</div>
            <div class="col-md-3">{{ form.supplier.label_tag }} {{ form.supplier }}</div>
            <div class="col-md-3">{{ form.type_description.label_tag }} {{ form.type_description }}</div>
            <div class="col-md-3">
                <div class="row g-2">
                    <div class="col-6">{{ form.lm.label_tag }} {{ form.lm }}</div>
                    <div class="col-6">{{ form.posted.label_tag }} {{ form.posted }}</div>
                </div>
            </div>
            <div class="col-md-8">{{ form.description.label_tag }} {{ form.description }}</div>
            <div class="col-md-4">{{ form.supervisor.label_tag }} {{ form.supervisor }}</div>
            <div class="col-md-2">{{ form.estimate.label_tag }} {{ form.estimate }}</div>
            <div class="col-md-2">{{ form.qty.label_tag }} {{ form.qty }}</div>
            <div class="col-md-2">{{ form.supplies_cost.label_tag }} {{ form.supplies_cost }}</div>
            <div class="col-md-2">{{ form.tax_fees.label_tag }} {{ form.tax_fees }}</div>
            <div class="col-md-2">{{ form.cost.label_tag }} {{ form.cost }}</div>
            <div class="col-md-2">{{ form.invoiced_amt.label_tag }} {{ form.invoiced_amt }}</div>
            <div class="col-md-3">{{ form.stage.label_tag }} {{ form.stage }}</div>
            <div class="col-md-3">{{ form.lc_stage.label_tag }} {{ form.lc_stage }}</div>
            <div class="col-md-3">{{ form.invoice_number.label_tag }} {{ form.invoice_number }}</div>
            <div class="col-md-3">{{ form.delivery_type.label_tag }} {{ form.delivery_type }}</div>
            <div class="col-md-4">{{ form.materials.label_tag }} {{ form.materials }}</div>
            <div class="col-md-4">{{ form.book_number.label_tag }} {{ form.book_number }}</div>
            <div class="col-md-4">{{ form.notes.label_tag }} {{ form.notes }}</div>
        </div>
        {% if form.errors %}
        <div class="alert alert-danger mt-3">
            <ul class="mb-0">
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                <li><strong>{{ field }}:</strong> {{ error }}</li>
                {% endfor %}
            {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endfor %}

    <div class="mt-4 d-flex gap-2">
        <button type="submit" class="btn btn-accent"><i class="bi bi-scissors"></i> Split Entry</button>
        <a href="{% url 'ledger:entry_detail' entry.pk %}" class="btn btn-secondary">Cancel</a>
    </div>
</form>
{% endblock %}
