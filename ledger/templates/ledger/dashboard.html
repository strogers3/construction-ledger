{% extends "ledger/base.html" %}
{% load humanize %}

{% block title %}Dashboard - Construction Ledger{% endblock %}

{% block content %}
<h4 class="mb-4"><i class="bi bi-speedometer2"></i> Dashboard</h4>

<!-- Stat Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-2">
        <div class="card stat-card p-3">
            <div class="stat-label">Total Entries</div>
            <div class="stat-value">{{ total_entries|intcomma }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card p-3">
            <div class="stat-label">Total Cost <small class="text-muted">(excl. Transfers)</small></div>
            <div class="stat-value">${{ total_cost|floatformat:2|intcomma }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card p-3">
            <div class="stat-label">Total Transfers</div>
            <div class="stat-value"><a href="{% url 'ledger:entry_list' %}?lm=X" style="color:inherit;text-decoration:none;">${{ total_transfers|floatformat:2|intcomma }}</a></div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stat-card p-3">
            <div class="stat-label">Suppliers</div>
            <div class="stat-value">{{ total_suppliers }}</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stat-card p-3">
            <div class="stat-label">Date Range</div>
            <div class="stat-value" style="font-size:1.1rem;">
                {% if date_range.min_date %}
                    {{ date_range.min_date|date:"M d, Y" }}<br>
                    <span style="color:#999;font-size:0.8rem;">to</span>
                    {{ date_range.max_date|date:"M d, Y" }}
                {% else %}
                    N/A
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row g-3 mb-4">
    <div class="col-lg-8">
        <div class="card p-3">
            <h6 class="text-muted mb-3">Cost by Type</h6>
            <div style="height:400px;"><canvas id="typeChart"></canvas></div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card p-3">
            <h6 class="text-muted mb-3">Cost by Category</h6>
            <div style="height:400px;"><canvas id="lmChart"></canvas></div>
        </div>
    </div>
</div>

<!-- Transfers Chart -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card p-3">
            <h6 class="text-muted mb-3">Transfers by Type</h6>
            <div style="height:350px;"><canvas id="transferChart"></canvas></div>
        </div>
    </div>
</div>

<!-- Cost by Supplier (excl. Transfers) -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card p-3">
            <h6 class="text-muted mb-3">Cost by Supplier (excl. Transfers)</h6>
            <div style="height:500px;"><canvas id="supplierPieChart"></canvas></div>
        </div>
    </div>
</div>

<!-- Recent Entries -->
<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="text-muted mb-0">Recent Entries</h6>
        <a href="{% url 'ledger:entry_list' %}" class="btn btn-sm btn-accent">View All</a>
    </div>
    <div class="table-responsive">
        <table class="table table-sm mb-0">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Supplier</th>
                    <th>Type</th>
                    <th>L/M</th>
                    <th class="text-end">Cost</th>
                </tr>
            </thead>
            <tbody>
                {% for e in recent_entries %}
                <tr>
                    <td>{{ e.date|date:"m/d/Y"|default:"—" }}</td>
                    <td><a href="{% url 'ledger:entry_detail' e.pk %}">{{ e.description|truncatechars:50|default:"—" }}</a></td>
                    <td>{{ e.supplier.name|default:"—" }}</td>
                    <td>{{ e.type_description|default:"—" }}</td>
                    <td>
                        {% if e.lm %}
                        <span class="badge badge-lm-{{ e.lm }}">{{ e.get_lm_display }}</span>
                        {% else %}—{% endif %}
                    </td>
                    <td class="text-end">{% if e.cost != None %}${{ e.cost|floatformat:2|intcomma }}{% else %}—{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
const typeColors = ['#f0ad4e','#3b82f6','#10b981','#ef4444','#8b5cf6','#ec4899','#14b8a6','#f97316','#6366f1','#84cc16','#06b6d4'];
const typeIds = {{ type_ids|safe }};

new Chart(document.getElementById('typeChart'), {
    type: 'bar',
    data: {
        labels: {{ type_labels|safe }},
        datasets: [{
            label: 'Total Cost',
            data: {{ type_values|safe }},
            backgroundColor: typeColors,
            borderRadius: 4,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        onClick: (evt, elements) => {
            if (elements.length > 0) {
                const idx = elements[0].index;
                window.location.href = '/entries/?type=' + typeIds[idx];
            }
        },
        onHover: (evt, elements) => {
            evt.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        },
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: ctx => '$' + ctx.parsed.y.toLocaleString(undefined, {minimumFractionDigits:2})
                }
            }
        },
        scales: {
            x: { ticks: { color: '#999', maxRotation: 45 }, grid: { display: false } },
            y: { ticks: { color: '#999', callback: v => '$' + (v/1000).toFixed(0) + 'k' }, grid: { color: '#333' } }
        }
    }
});

const lmColors = ['#3b82f6','#10b981','#8b5cf6','#6b7280'];
const lmCodes = {{ lm_codes|safe }};
new Chart(document.getElementById('lmChart'), {
    type: 'doughnut',
    data: {
        labels: {{ lm_labels|safe }},
        datasets: [{
            data: {{ lm_values|safe }},
            backgroundColor: lmColors,
            borderWidth: 0,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        onClick: (evt, elements) => {
            if (elements.length > 0) {
                const idx = elements[0].index;
                window.location.href = '/entries/?lm=' + lmCodes[idx];
            }
        },
        onHover: (evt, elements) => {
            evt.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        },
        plugins: {
            legend: { position: 'bottom', labels: { color: '#999', padding: 15 } },
            tooltip: {
                callbacks: {
                    label: ctx => ctx.label + ': $' + ctx.parsed.toLocaleString(undefined, {minimumFractionDigits:2})
                }
            }
        }
    }
});

const transferColors = ['#f0ad4e','#3b82f6','#10b981','#ef4444','#8b5cf6','#ec4899','#14b8a6','#f97316','#6366f1','#84cc16','#06b6d4'];
const transferIds = {{ transfer_ids|safe }};
new Chart(document.getElementById('transferChart'), {
    type: 'bar',
    data: {
        labels: {{ transfer_labels|safe }},
        datasets: [{
            label: 'Transfer Cost',
            data: {{ transfer_values|safe }},
            backgroundColor: transferColors,
            borderRadius: 4,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        onClick: (evt, elements) => {
            if (elements.length > 0) {
                const idx = elements[0].index;
                window.location.href = '/suppliers/' + transferIds[idx] + '/';
            }
        },
        onHover: (evt, elements) => {
            evt.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        },
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: ctx => '$' + ctx.parsed.y.toLocaleString(undefined, {minimumFractionDigits:2})
                }
            }
        },
        scales: {
            x: { ticks: { color: '#999', maxRotation: 45 }, grid: { display: false } },
            y: { ticks: { color: '#999', callback: v => '$' + (v/1000).toFixed(0) + 'k' }, grid: { color: '#333' } }
        }
    }
});

const supplierIds = {{ supplier_ids|safe }};
const supplierColors = [];
for (let i = 0; i < {{ supplier_labels|safe }}.length; i++) {
    supplierColors.push(`hsl(${(i * 37) % 360}, 65%, 55%)`);
}
const supplierPieChart = new Chart(document.getElementById('supplierPieChart'), {
    type: 'pie',
    data: {
        labels: {{ supplier_labels|safe }},
        datasets: [{
            data: {{ supplier_values|safe }},
            backgroundColor: supplierColors,
            borderWidth: 1,
            borderColor: '#22262e',
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        onClick: (evt, elements) => {
            if (elements.length > 0) {
                const idx = elements[0].index;
                window.location.href = '/suppliers/' + supplierIds[idx] + '/';
            }
        },
        plugins: {
            legend: { position: 'right', labels: { color: '#999', padding: 8, font: { size: 11 } } },
            tooltip: {
                callbacks: {
                    label: ctx => ctx.label + ': $' + ctx.parsed.toLocaleString(undefined, {minimumFractionDigits:2})
                }
            }
        },
        onHover: (evt, elements) => {
            evt.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        }
    }
});
</script>
{% endblock %}
