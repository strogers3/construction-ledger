{% extends "ledger/base.html" %}
{% load humanize %}

{% block title %}Entries - Construction Ledger{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center gap-3">
        <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i></a>
        <h4 class="mb-0"><i class="bi bi-list-ul"></i> Construction Entries</h4>
    </div>
    <div class="d-flex align-items-center gap-3">
        <span class="text-muted">{{ total_filtered }} entries</span>
        {% if perms.ledger.add_constructionentry %}
        <a href="{% url 'ledger:entry_create' %}" class="btn btn-accent btn-sm">
            <i class="bi bi-plus-lg"></i> New Entry
        </a>
        {% endif %}
    </div>
</div>

<!-- Filters -->
<div class="filter-bar p-3 mb-4">
    <form method="get" id="filterForm">
        <input type="hidden" name="sort" value="{{ current_filters.sort }}">
        <input type="hidden" name="dir" value="{{ current_filters.dir }}">
        <div class="row g-2 align-items-end">
            <div class="col-md-2">
                <label class="form-label small text-muted">Search</label>
                <input type="text" name="search" class="form-control form-control-sm" placeholder="Description, notes, invoice..." value="{{ current_filters.search }}">
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Supplier</label>
                <select name="supplier" class="form-select form-select-sm">
                    <option value="">All Suppliers</option>
                    {% for s in suppliers %}
                    <option value="{{ s.id }}" {% if current_filters.supplier == s.id|stringformat:"d" %}selected{% endif %}>{{ s.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Type</label>
                <select name="type" class="form-select form-select-sm">
                    <option value="">All Types</option>
                    {% for t in types %}
                    <option value="{{ t.id }}" {% if current_filters.type == t.id|stringformat:"d" %}selected{% endif %}>{{ t }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label small text-muted">L/M</label>
                <select name="lm" class="form-select form-select-sm">
                    <option value="">All</option>
                    <option value="L" {% if current_filters.lm == "L" %}selected{% endif %}>Labor</option>
                    <option value="M" {% if current_filters.lm == "M" %}selected{% endif %}>Materials</option>
                    <option value="U" {% if current_filters.lm == "U" %}selected{% endif %}>Utility</option>
                    <option value="X" {% if current_filters.lm == "X" %}selected{% endif %}>Transfer</option>
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label small text-muted">Posted</label>
                <select name="posted" class="form-select form-select-sm">
                    <option value="">All</option>
                    <option value="Yes" {% if current_filters.posted == "Yes" %}selected{% endif %}>Yes</option>
                    <option value="Inv" {% if current_filters.posted == "Inv" %}selected{% endif %}>Inv</option>
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label small text-muted">From</label>
                <input type="date" name="date_from" class="form-control form-control-sm" value="{{ current_filters.date_from }}">
            </div>
            <div class="col-md-1">
                <label class="form-label small text-muted">To</label>
                <input type="date" name="date_to" class="form-control form-control-sm" value="{{ current_filters.date_to }}">
            </div>
            <div class="col-md-2 d-flex gap-1">
                <button type="submit" class="btn btn-sm btn-accent flex-grow-1">Filter</button>
                <a href="{% url 'ledger:entry_list' %}" class="btn btn-sm btn-outline-secondary">Clear</a>
            </div>
        </div>
    </form>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col">
        <div class="card stat-card p-3">
            <div class="stat-label">Entries</div>
            <div class="stat-value">{{ totals.entry_count }}</div>
        </div>
    </div>
    <div class="col">
        <div class="card stat-card p-3">
            <div class="stat-label">Total Cost</div>
            <div class="stat-value">${{ totals.total_cost|floatformat:2|intcomma|default:"0.00" }}</div>
        </div>
    </div>
    {% for lm in lm_subtotals %}
    <div class="col">
        <div class="card p-3" style="border-left: 4px solid {% if lm.code == 'L' %}#3b82f6{% elif lm.code == 'M' %}#10b981{% elif lm.code == 'U' %}#8b5cf6{% else %}#6b7280{% endif %};">
            <div class="stat-label">{{ lm.label }} <small class="text-muted">({{ lm.count }})</small></div>
            <div class="stat-value">${{ lm.total|floatformat:2|intcomma }}</div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Table -->
<div class="card p-0">
    <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
            <thead>
                <tr>
                    {% with cf=current_filters %}
                    <th>
                        <a class="sort-link" href="?sort=date&dir={% if cf.sort == 'date' and cf.dir == 'asc' %}desc{% else %}asc{% endif %}&search={{ cf.search|urlencode }}&supplier={{ cf.supplier }}&type={{ cf.type }}&lm={{ cf.lm }}&posted={{ cf.posted }}&date_from={{ cf.date_from }}&date_to={{ cf.date_to }}">
                            Date {% if cf.sort == 'date' %}{% if cf.dir == 'asc' %}<i class="bi bi-caret-up-fill"></i>{% else %}<i class="bi bi-caret-down-fill"></i>{% endif %}{% endif %}
                        </a>
                    </th>
                    <th>
                        <a class="sort-link" href="?sort=description&dir={% if cf.sort == 'description' and cf.dir == 'asc' %}desc{% else %}asc{% endif %}&search={{ cf.search|urlencode }}&supplier={{ cf.supplier }}&type={{ cf.type }}&lm={{ cf.lm }}&posted={{ cf.posted }}&date_from={{ cf.date_from }}&date_to={{ cf.date_to }}">
                            Description {% if cf.sort == 'description' %}{% if cf.dir == 'asc' %}<i class="bi bi-caret-up-fill"></i>{% else %}<i class="bi bi-caret-down-fill"></i>{% endif %}{% endif %}
                        </a>
                    </th>
                    <th>
                        <a class="sort-link" href="?sort=supplier__name&dir={% if cf.sort == 'supplier__name' and cf.dir == 'asc' %}desc{% else %}asc{% endif %}&search={{ cf.search|urlencode }}&supplier={{ cf.supplier }}&type={{ cf.type }}&lm={{ cf.lm }}&posted={{ cf.posted }}&date_from={{ cf.date_from }}&date_to={{ cf.date_to }}">
                            Supplier {% if cf.sort == 'supplier__name' %}{% if cf.dir == 'asc' %}<i class="bi bi-caret-up-fill"></i>{% else %}<i class="bi bi-caret-down-fill"></i>{% endif %}{% endif %}
                        </a>
                    </th>
                    <th>
                        <a class="sort-link" href="?sort=type_description__code&dir={% if cf.sort == 'type_description__code' and cf.dir == 'asc' %}desc{% else %}asc{% endif %}&search={{ cf.search|urlencode }}&supplier={{ cf.supplier }}&type={{ cf.type }}&lm={{ cf.lm }}&posted={{ cf.posted }}&date_from={{ cf.date_from }}&date_to={{ cf.date_to }}">
                            Type {% if cf.sort == 'type_description__code' %}{% if cf.dir == 'asc' %}<i class="bi bi-caret-up-fill"></i>{% else %}<i class="bi bi-caret-down-fill"></i>{% endif %}{% endif %}
                        </a>
                    </th>
                    <th>
                        <a class="sort-link" href="?sort=lm&dir={% if cf.sort == 'lm' and cf.dir == 'asc' %}desc{% else %}asc{% endif %}&search={{ cf.search|urlencode }}&supplier={{ cf.supplier }}&type={{ cf.type }}&lm={{ cf.lm }}&posted={{ cf.posted }}&date_from={{ cf.date_from }}&date_to={{ cf.date_to }}">
                            L/M {% if cf.sort == 'lm' %}{% if cf.dir == 'asc' %}<i class="bi bi-caret-up-fill"></i>{% else %}<i class="bi bi-caret-down-fill"></i>{% endif %}{% endif %}
                        </a>
                    </th>
                    <th class="text-end">
                        <a class="sort-link" href="?sort=cost&dir={% if cf.sort == 'cost' and cf.dir == 'asc' %}desc{% else %}asc{% endif %}&search={{ cf.search|urlencode }}&supplier={{ cf.supplier }}&type={{ cf.type }}&lm={{ cf.lm }}&posted={{ cf.posted }}&date_from={{ cf.date_from }}&date_to={{ cf.date_to }}">
                            Cost {% if cf.sort == 'cost' %}{% if cf.dir == 'asc' %}<i class="bi bi-caret-up-fill"></i>{% else %}<i class="bi bi-caret-down-fill"></i>{% endif %}{% endif %}
                        </a>
                    </th>
                    <th>Posted</th>
                    {% endwith %}
                </tr>
            </thead>
            <tbody>
                {% for e in page_obj %}
                <tr>
                    <td class="text-nowrap">{{ e.date|date:"m/d/Y"|default:"—" }}</td>
                    <td><a href="{% url 'ledger:entry_detail' e.pk %}">{{ e.description|truncatechars:60|default:"—" }}</a></td>
                    <td>{% if e.supplier %}<a href="{% url 'ledger:supplier_detail' e.supplier.pk %}">{{ e.supplier.name }}</a>{% else %}—{% endif %}</td>
                    <td>{{ e.type_description|default:"—" }}</td>
                    <td>
                        {% if e.lm %}
                        <span class="badge badge-lm-{{ e.lm }}">{{ e.get_lm_display }}</span>
                        {% else %}—{% endif %}
                    </td>
                    <td class="text-end text-nowrap">{% if e.cost != None %}${{ e.cost|floatformat:2|intcomma }}{% else %}—{% endif %}</td>
                    <td>{{ e.posted|default:"—" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="7" class="text-center text-muted py-4">No entries found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<nav class="mt-3">
    <ul class="pagination pagination-sm justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&sort={{ current_filters.sort }}&dir={{ current_filters.dir }}&search={{ current_filters.search|urlencode }}&supplier={{ current_filters.supplier }}&type={{ current_filters.type }}&lm={{ current_filters.lm }}&posted={{ current_filters.posted }}&date_from={{ current_filters.date_from }}&date_to={{ current_filters.date_to }}">&laquo;</a></li>
        {% endif %}
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}&sort={{ current_filters.sort }}&dir={{ current_filters.dir }}&search={{ current_filters.search|urlencode }}&supplier={{ current_filters.supplier }}&type={{ current_filters.type }}&lm={{ current_filters.lm }}&posted={{ current_filters.posted }}&date_from={{ current_filters.date_from }}&date_to={{ current_filters.date_to }}">{{ num }}</a></li>
            {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&sort={{ current_filters.sort }}&dir={{ current_filters.dir }}&search={{ current_filters.search|urlencode }}&supplier={{ current_filters.supplier }}&type={{ current_filters.type }}&lm={{ current_filters.lm }}&posted={{ current_filters.posted }}&date_from={{ current_filters.date_from }}&date_to={{ current_filters.date_to }}">&raquo;</a></li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}
